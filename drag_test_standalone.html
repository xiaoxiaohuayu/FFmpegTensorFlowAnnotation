<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Canvas拖拽测试 - 独立版本</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    canvas {
      border: 2px solid #333;
      cursor: crosshair;
      background: #fafafa;
      width: 100%;
      max-width: 600px;
      height: auto;
    }
    .instructions {
      margin-top: 20px;
      padding: 15px;
      background: #e3f2fd;
      border-radius: 4px;
    }
    .logs {
      margin-top: 20px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    .log-entry {
      margin: 2px 0;
    }
    button {
      padding: 8px 16px;
      background: #2196f3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #1976d2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Canvas拖拽测试 - 独立版本</h1>
    
    <div style="text-align: center;">
      <canvas id="testCanvas" width="600" height="400"></canvas>
    </div>
    
    <div class="controls">
      <button id="resetButton">重置控制点</button>
      <button id="addPointButton">添加新点</button>
    </div>
    
    <div class="instructions">
      <h3>使用说明：</h3>
      <ul>
        <li>点击红色圆点并拖动来移动它们</li>
        <li>拖动时鼠标会变成"grabbing"状态</li>
        <li>所有操作都会在下方日志中显示</li>
      </ul>
    </div>
    
    <div class="logs" id="logs">
      <div class="log-entry">=== 调试日志 ===</div>
    </div>
  </div>

  <script>
    // 获取DOM元素
    const canvas = document.getElementById('testCanvas');
    const ctx = canvas.getContext('2d');
    const logsElement = document.getElementById('logs');
    const resetButton = document.getElementById('resetButton');
    const addPointButton = document.getElementById('addPointButton');
    
    // 拖拽状态
    let dragState = {
      isDragging: false,
      dragIndex: -1,
      offsetX: 0,
      offsetY: 0
    };
    
    // 控制点数据
    let controlPoints = [];
    
    // 添加日志
    function addLog(message) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString();
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.textContent = `[${timeStr}] ${message}`;
      logsElement.appendChild(logEntry);
      logsElement.scrollTop = logsElement.scrollHeight;
      console.log(`[${timeStr}] ${message}`);
    }
    
    // 获取鼠标在canvas中的坐标
    function getMousePos(canvas, e) {
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      
      return {
        x: (e.clientX - rect.left) * scaleX,
        y: (e.clientY - rect.top) * scaleY
      };
    }
    
    // 查找最近的控制点
    function findNearbyPoint(x, y, points, tolerance = 25) {
      addLog(`查找最近控制点 - 位置: (${Math.round(x)}, ${Math.round(y)}), 阈值: ${tolerance}`);
      let minDist = tolerance;
      let closestIndex = -1;
      
      points.forEach((point, index) => {
        const dist = Math.sqrt((point.x - x) ** 2 + (point.y - y) ** 2);
        if (dist < minDist) {
          minDist = dist;
          closestIndex = index;
        }
      });
      
      if (closestIndex !== -1) {
        addLog(`找到最近控制点: 索引=${closestIndex}, 距离=${minDist.toFixed(2)}`);
      }
      
      return closestIndex;
    }
    
    // 绘制整个画布
    function renderCanvas() {
      // 清空画布
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      // 绘制背景网格
      ctx.strokeStyle = '#e0e0e0';
      ctx.lineWidth = 1;
      for (let x = 0; x <= canvas.width; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, canvas.height);
        ctx.stroke();
      }
      for (let y = 0; y <= canvas.height; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(canvas.width, y);
        ctx.stroke();
      }
      
      // 绘制轮廓线
      if (controlPoints.length > 1) {
        ctx.strokeStyle = '#2196f3';
        ctx.lineWidth = 3;
        ctx.beginPath();
        
        controlPoints.forEach((point, index) => {
          if (index === 0) {
            ctx.moveTo(point.x, point.y);
          } else {
            ctx.lineTo(point.x, point.y);
          }
        });
        
        ctx.closePath();
        ctx.stroke();
      }
      
      // 绘制控制点（较大的圆点便于点击）
      ctx.fillStyle = '#f44336';
      controlPoints.forEach((point, index) => {
        // 如果是正在拖拽的点，用不同颜色表示
        if (dragState.isDragging && dragState.dragIndex === index) {
          ctx.fillStyle = '#9c27b0';
        } else {
          ctx.fillStyle = '#f44336';
        }
        
        ctx.beginPath();
        ctx.arc(point.x, point.y, 8, 0, Math.PI * 2);
        ctx.fill();
        
        // 绘制点的索引
        ctx.fillStyle = '#ffffff';
        ctx.font = '10px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(index, point.x, point.y);
      });
      
      addLog(`Canvas渲染完成 - ${controlPoints.length}个控制点`);
    }
    
    // 鼠标按下事件
    function handleMouseDown(e) {
      addLog('鼠标按下事件触发!');
      
      const pos = getMousePos(canvas, e);
      addLog(`鼠标按下位置: (${Math.round(pos.x)}, ${Math.round(pos.y)})`);
      
      const index = findNearbyPoint(pos.x, pos.y, controlPoints);
      if (index !== -1) {
        dragState.isDragging = true;
        dragState.dragIndex = index;
        dragState.offsetX = pos.x - controlPoints[index].x;
        dragState.offsetY = pos.y - controlPoints[index].y;
        canvas.style.cursor = 'grabbing';
        addLog(`开始拖拽控制点 ${index}`);
        e.preventDefault(); // 阻止默认行为
      }
    }
    
    // 鼠标移动事件
    function handleMouseMove(e) {
      if (dragState.isDragging && dragState.dragIndex !== -1) {
        const pos = getMousePos(canvas, e);
        
        // 更新控制点位置
        controlPoints[dragState.dragIndex].x = pos.x - dragState.offsetX;
        controlPoints[dragState.dragIndex].y = pos.y - dragState.offsetY;
        
        addLog(`移动控制点 ${dragState.dragIndex} 到: (${controlPoints[dragState.dragIndex].x.toFixed(1)}, ${controlPoints[dragState.dragIndex].y.toFixed(1)})`);
        
        // 重新渲染
        renderCanvas();
        e.preventDefault();
      } else {
        // 检查鼠标是否悬停在控制点上
        const pos = getMousePos(canvas, e);
        const index = findNearbyPoint(pos.x, pos.y, controlPoints);
        if (index !== -1) {
          canvas.style.cursor = 'pointer';
        } else {
          canvas.style.cursor = 'crosshair';
        }
      }
    }
    
    // 鼠标释放事件
    function handleMouseUp(e) {
      addLog('鼠标释放事件触发!');
      
      if (dragState.isDragging) {
        dragState.isDragging = false;
        dragState.dragIndex = -1;
        canvas.style.cursor = 'crosshair';
        addLog('拖拽结束');
      }
    }
    
    // 初始化控制点
    function initControlPoints() {
      // 创建一个简单的人物轮廓形状
      controlPoints = [
        { x: 300, y: 100 },  // 头部
        { x: 270, y: 170 },  // 左肩
        { x: 260, y: 250 },  // 左髋
        { x: 300, y: 350 },  // 底部
        { x: 340, y: 250 },  // 右髋
        { x: 330, y: 170 },  // 右肩
        { x: 300, y: 100 }   // 回到头部，闭合轮廓
      ];
      
      addLog(`初始化控制点: ${controlPoints.length}个点`);
      renderCanvas();
    }
    
    // 添加新点
    function addNewPoint() {
      if (controlPoints.length === 0) {
        controlPoints.push({ x: canvas.width / 2, y: canvas.height / 2 });
      } else {
        // 在最后一个点和第一个点之间添加一个新点
        const lastIndex = controlPoints.length - 1;
        const newX = (controlPoints[lastIndex].x + controlPoints[0].x) / 2;
        const newY = (controlPoints[lastIndex].y + controlPoints[0].y) / 2;
        controlPoints.splice(lastIndex, 0, { x: newX, y: newY });
      }
      
      addLog(`添加新点，现在有 ${controlPoints.length} 个点`);
      renderCanvas();
    }
    
    // 初始化事件监听器
    function initEvents() {
      canvas.addEventListener('mousedown', handleMouseDown);
      canvas.addEventListener('mousemove', handleMouseMove);
      canvas.addEventListener('mouseup', handleMouseUp);
      canvas.addEventListener('mouseleave', handleMouseUp);
      resetButton.addEventListener('click', initControlPoints);
      addPointButton.addEventListener('click', addNewPoint);
      
      addLog('事件监听器已初始化');
    }
    
    // 页面加载完成后初始化
    window.addEventListener('load', () => {
      addLog('页面加载完成，开始初始化');
      initEvents();
      initControlPoints();
      addLog('初始化完成，拖拽功能已准备就绪');
    });
  </script>
</body>
</html>